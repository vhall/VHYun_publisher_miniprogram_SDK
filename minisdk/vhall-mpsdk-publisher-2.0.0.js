const t="https://api.vhallyun.com",e="/sdk/v2/room/get-publish-info";class s{constructor({appId:t,roomId:e,accountId:s,token:r}){this.appId=t,this.roomId=e,this.accountId=s,this.token=r,this.request=this.request.bind(this),this.getRoomInfo=this.getRoomInfo.bind(this)}getRoomInfo(){return this.request(e)}request(e="",s={}){return s.client="wechat_applet",s.package_check="peter",s.app_id=this.appId,s.third_party_user_id=this.accountId,s.access_token=this.token,s.room_id=this.roomId,new Promise(((r,o)=>{wx.request({url:t+e,data:s,method:"POST",header:{"content-type":"application/x-www-form-urlencoded"},success:t=>{200==t.statusCode&&200==t.data.code?r(t.data.data):o(t)},fail:t=>{o(t)}})}))}}export default class{constructor(){this.appId=null,this.roomId=null,this.accountId=null,this.token=null,this.pusherId=null,this.singleAudio=null,this.THIS=null,this.createInstance=this.createInstance.bind(this),this.getPusherUrl=this.getPusherUrl.bind(this)}async createInstance({appId:t,roomId:e,accountId:r,token:o,pusherId:i,singleAudio:h=!1,THIS:n=null}){if("string"!=typeof t||!t)throw new Error("appId 必须为string且不为空");if("string"!=typeof e||!e)throw new Error("roomId 必须为string且不为空");if("string"!=typeof r||!r)throw new Error("accountId 必须为string且不为空");if("string"!=typeof o||!o)throw new Error("token 必须为string且不为空");if("string"!=typeof i||!i)throw new Error("pusherId 必须为string且不为空");let u;this.appId=t,this.roomId=e,this.accountId=r,this.token=o,this.pusherId=i,this.singleAudio=h,this.THIS=n,this.api=new s({appId:t,roomId:e,accountId:r,token:o});try{u=await this.getPusherUrl()}catch(t){return Promise.reject({msg:"获取推流地址失败"})}return{url:u}}async getPusherUrl(){let t;try{t=await this.api.getRoomInfo()}catch(t){return Promise.reject(t)}const{publish_args:e,publish_domainname:s}=t.publish_server,{accesstoken:r,vhost:o}=e;let i="";return i=this.singleAudio?`${s[0]}?vhost=pureAudioSpeexVhost?token=${e.token}?webinar_id=${this.roomId}?ismix=0?mixserver=?accesstoken=${r}/${this.roomId}`:`${s[0]}?vhost=${o}?token=${e.token}?webinar_id=${this.roomId}?ismix=0?mixserver=?accesstoken=${r}/${this.roomId}`,i}destroy(){this.THIS=null}start(t){this.pusherContext.start(t)}stop(t){this.pusherContext.stop(t)}pause(t){this.pusherContext.pause(t)}resume(t){this.pusherContext.resume(t)}switchCamera(t){this.pusherContext.switchCamera(t)}snapshot(t){this.pusherContext.snapshot(t)}toggleTorch(t){this.pusherContext.toggleTorch(t)}playBGM(t){this.pusherContext.playBGM(t)}pauseBGM(t){this.pusherContext.pauseBGM(t)}resumeBGM(t){this.pusherContext.resumeBGM(t)}stopBGM(t){this.pusherContext.stopBGM(t)}setBGMVolume(t){this.pusherContext.setBGMVolume(t)}setMICVolume(t){this.pusherContext.setMICVolume(t)}startPreview(t){this.pusherContext.startPreview(t)}stopPreview(t){this.pusherContext.stopPreview(t)}sendMessage(t){this.pusherContext.sendMessage(t)}statechange(){}netstatuschange(){}pusherror(){}bgmstart(){}bgmprogress(){}bgmcomplete(){}get pusherContext(){return wx.createLivePusherContext(this.pusherId,this.THIS)}}
